<!DOCTYPE html>

<head>
  <title>Facturapeute - La tarification 590 facile</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
</head>

<body>
  <div class="container">
    <h1>Facture</h1>
    <form class="form-horizontal" onsubmit=generateReceipt(event)>
      <h2>Informations générales</h2>
      <div class="columns">
        <div class="column col-6">
          <div class="card" id="author-card">
            <div class="card-header">
              <div class="card-title h5">
                Auteur de la facture
              </div>
            </div>
            <div class="card-body">
              <span id="author-name-display"></span>
              <div class="show-class">
                <div class="form-group">
                  <label class="form-label" for="author-name">Nom ou entreprise</label>
                  <input class="form-input" type="text" id="author-name" name="author-name" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="author-rcc-number">N° RCC</label>
                  <input class="form-input" type="text" id="author-rcc-number" name="author-rcc-number" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="author-street">Rue et n°</label>
                  <input class="form-input" type="text" id="author-street" name="author-street" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="author-npa">NPA</label>
                  <input class="form-input" type="text" id="author-npa" name="author-npa" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="author-city">Localité</label>
                  <input class="form-input" type="text" id="author-city" name="author-city" required>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="column col-6">
          <div class="card" id="therapist-card">
            <div class="card-header">
              <div class="card-title h5">
                Thérapeute
              </div>
            </div>
            <div class="card-body">
              <span id="therapist-name-display"></span>
              <div class="show-class">
                <div class="form-group">
                  <label class="form-label" for="therapist-first-name">Prénom</label>
                  <input class="form-input" type="text" id="therapist-first-name" name="therapist-first-name" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="therapist-last-name">Nom</label>
                  <input class="form-input" type="text" id="therapist-last-name" name="therapist-last-name" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="therapist-rcc-number">N° RCC</label>
                  <input class="form-input" type="text" id="therapist-rcc-number" name="therapist-rcc-number" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="therapist-street">Rue et n°</label>
                  <input class="form-input" type="text" id="therapist-street" name="therapist-street" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="therapist-npa">NPA</label>
                  <input class="form-input" type="text" id="therapist-npa" name="therapist-npa" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="therapist-city">Localité</label>
                  <input class="form-input" type="text" id="therapist-city" name="therapist-city" required>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button class="btn btn-sm btn-primary btn-edit-info hide-class" onclick=editInfo(event)>
        Modifier les informations
      </button>
      <h2>Informations du patient</h2>
      <div class="customers-list-container hide-class">
        <h5>Mes patients</h5>
        <div id="customers-list"></div>
      </div>
      <div class="form-group">
        <div class="col-6">
          <label class="form-label" for="customer-first-name">Prénom</label>
          <input class="form-input" type="text" id="customer-first-name" name="customer-first-name" required>
        </div>
        <div class="col-6">
          <label class="form-label" for="customer-last-name">Nom</label>
          <input class="form-input" type="text" id="customer-last-name" name="customer-last-name" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="customer-street">Rue et n°</label>
        <input class="form-input" type="text" id="customer-street" name="customer-street" required>
      </div>
      <div class="form-group">
        <div class="col-6">
          <label class="form-label" for="customer-npa">NPA</label>
          <input class="form-input" type="text" id="customer-npa" name="customer-npa" required>
        </div>
        <div class="col-6">
          <label class="form-label" for="customer-city">Localité</label>
          <input class="form-input" type="text" id="customer-city" name="customer-city" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="customer-birthdate">Date de naissance</label>
        <input class="form-input" type="date" id="customer-birthdate" name="customer-birthdate" required>
      </div>
      <h2>Description de la séance</h2>
      <div class="form-group">
        <div class="col-2">
          <label class="form-label" for="service-price">Tarif horaire</label>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-price" name="service-price" min="0" max="200"
            onkeyup=onPriceEdit() data-amount required>
        </div>
        <div class="col-1">
          <label class="form-label">CHF</label>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-1" name="service-code-1" required>
            <option value="1003" selected>1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-1" name="service-duration-1"
            placeholder="Durée (minutes)" step="5" min="0" data-amount required>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-2" name="service-code-2">
            <option value="" selected></option>
            <option value="1003">1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-2" name="service-duration-2"
            placeholder="Durée (minutes)" step="5" min="0" data-amount>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-3" name="service-code-3">
            <option value="" selected></option>
            <option value="1003">1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-3" name="service-duration-3"
            placeholder="Durée (minutes)" step="5" min="0" data-amount>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-4" name="service-code-4">
            <option value="" selected></option>
            <option value="1003">1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-4" name="service-duration-4"
            placeholder="Durée (minutes)" step="5" min="0" data-amount>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-5" name="service-code-5">
            <option value="" selected></option>
            <option value="1003">1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-5" name="service-duration-5"
            placeholder="Durée (minutes)" step="5" min="0" data-amount>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">
          Total : <span id="total-amount">0.0</span> CHF
        </label>
      </div>
      <input class="form-input btn btn-lg btn-primary" type="submit" value="Générer la facture">
    </form>
  </div>
</body>

<style>
  .container {
    width: 750px;
    margin-top: 2rem;
    margin-bottom: 3rem;
  }

  h1 {
    text-align: center;
  }

  h2 {
    margin: 1.5rem 0 0.5rem 0;
  }

  .show-class {
    display: block;
  }

  .hide-class {
    display: none;
  }

  #author-card,
  #therapist-card {
    text-align: center;
    height: 100%;
  }

  .btn-edit-info {
    width: 100%;
    margin-top: 1rem;
  }

  #customers-list {
    display: flex;
    overflow: scroll;
    margin-bottom: 0.4rem;
  }

  .customer-card {
    min-width: 150px;
    margin-right: 0.8rem;
  }

  .form-group .col-6:not(:last-child),
  .form-group .col-9 {
    padding-right: 0.75rem;
  }

  .form-group .col-6:last-child,
  .form-group .col-3,
  .form-group .col-1 {
    padding-left: 0.75rem;
  }

  input[type=submit] {
    margin-top: 2rem
  }
</style>

<script src="utils.js"></script>

<script>
  let isInfoEdited = false;
  let customers;

  Array.from(document.querySelectorAll('[data-amount]')).forEach(dataAmountElement => {
    dataAmountElement.addEventListener('change', updateTotalAmount);
    dataAmountElement.addEventListener('keyup', updateTotalAmount);
  });

  loadAuthorBackup();
  loadTherapistBackup();
  loadCustomersBackup();
  loadServicePriceBackup();

  updateTotalAmount();

  function loadAuthorBackup() {
    const author = JSON.parse(localStorage.getItem('author'));

    if (author) {
      $('#author-card .show-class').className = 'hide-class';
      $('#author-name-display').innerHTML = author.name;
      $('#author-name').value = author.name;
      $('#author-rcc-number').value = author.RCCNumber;
      $('#author-street').value = author.street;
      $('#author-npa').value = author.NPA;
      $('#author-city').value = author.city;
      $('.btn-edit-info').className = 'btn btn-sm btn-primary btn-edit-info show-class'
    }
  }

  function loadTherapistBackup() {
    const therapist = JSON.parse(localStorage.getItem('therapist'));

    if (therapist) {
      $('#therapist-card .show-class').className = 'hide-class';
      $('#therapist-name-display').innerHTML = `${therapist.firstName} ${therapist.lastName}`;
      $('#therapist-first-name').value = therapist.firstName;
      $('#therapist-last-name').value = therapist.lastName;
      $('#therapist-rcc-number').value = therapist.RCCNumber;
      $('#therapist-street').value = therapist.street;
      $('#therapist-npa').value = therapist.NPA;
      $('#therapist-city').value = therapist.city;
      $('.btn-edit-info').className = 'btn btn-sm btn-primary btn-edit-info show-class'
    }
  }

  function loadCustomersBackup() {
    customers = JSON.parse(localStorage.getItem('customers'));

    if (customers) {
      customers.sort((a, b) => b.frequency - a.frequency);

      $('.customers-list-container').className = 'customers-list-container show-class';

      customers.forEach((customer, i) => {
        $('#customers-list').innerHTML +=
          `<div class="card customer-card" id="customer-${i}" onclick=selectCustomer(${i})>
            <div class="card-body">
              ${customer.firstName}<br>
              ${customer.lastName}
            </div>
          </div>`
      });
    }
  }

  function loadServicePriceBackup() {
    const servicePrice = JSON.parse(localStorage.getItem('servicePrice'));

    if (servicePrice) $('#service-price').value = servicePrice;
  }

  function editInfo(e) {
    e.preventDefault();

    $('#author-card .hide-class').className = 'show-class';
    $('#therapist-card .hide-class').className = 'show-class';
    $('.btn-edit-info').className = 'btn btn-sm btn-primary btn-edit-info hide-class';

    isInfoEdited = true;
  }

  function selectCustomer(i) {
    $('#customer-first-name').value = customers[i].firstName;
    $('#customer-last-name').value = customers[i].lastName;
    $('#customer-street').value = customers[i].street;
    $('#customer-npa').value = customers[i].NPA;
    $('#customer-city').value = customers[i].city;
    $('#customer-birthdate').value = dateObjectToDateInput(new Date(customers[i].birthdate));
  }

  function onPriceEdit() {
    isInfoEdited = true;
  }

  function updateTotalAmount() {
    let totalAmount = 0;
    const price = Number($('#service-price').value) / 12;

    for (let i = 1; i <= 5; i++)
      totalAmount += (Number($(`#service-duration-${i}`).value) / 5) * price;

    $('#total-amount').innerHTML = totalAmount.toFixed(2);
  }

  function generateReceipt(e) {
    e.preventDefault();

    const author = getAuthorData();
    const therapist = getTherapistData();
    const customer = getCustomerData();

    const servicePrice = $('#service-price').value;

    const receiptContent = {
      author: author,
      therapist: therapist,
      customer: customer,
      servicePrice: servicePrice,
      services: getServicesData()
    };

    saveData('author', author);
    saveData('therapist', therapist);
    saveData('servicePrice', servicePrice);
    saveCustomer(customer);

    const receiptContentBase64 = btoa(JSON.stringify(receiptContent));
    const receiptFilename = `facture-${Date.now()}.pdf`;
    const receiptURL = encodeURIComponent(`http://590.terrapeute.ch/receipt.html?receiptContent=${receiptContentBase64}`);
    const url = `http://f.terrapeute.ch/pdf/${receiptURL}/${receiptFilename}`;

    const link = document.createElement("a");
    link.download = receiptFilename;
    link.href = url;
    link.click();
  };

  function getAuthorData() {
    return {
      name: $('#author-name').value,
      RCCNumber: $('#author-rcc-number').value,
      street: $('#author-street').value,
      NPA: $('#author-npa').value,
      city: $('#author-city').value
    };
  }

  function getTherapistData() {
    return {
      firstName: $('#therapist-first-name').value,
      lastName: $('#therapist-last-name').value,
      RCCNumber: $('#therapist-rcc-number').value,
      street: $('#therapist-street').value,
      NPA: $('#therapist-npa').value,
      city: $('#therapist-city').value
    };
  }

  function getCustomerData() {
    return {
      firstName: $('#customer-first-name').value,
      lastName: $('#customer-last-name').value,
      street: $('#customer-street').value,
      NPA: $('#customer-npa').value,
      city: $('#customer-city').value,
      birthdate: $('#customer-birthdate').value,
      frequency: 1
    };
  }

  function getServicesData() {
    const services = [];

    for (let i = 1; i <= 5; i++) {
      const serviceCode = $(`#service-code-${i}`).value;

      if (serviceCode) {
        const service = {
          code: serviceCode,
          duration: $(`#service-duration-${i}`).value
        };

        services.push(service);
      }
    }

    return services;
  }

  function saveData(dataName, data) {
    if (!localStorage.getItem(dataName) || isInfoEdited)
      localStorage.setItem(dataName, JSON.stringify(data));
  }

  function saveCustomer(customer) {
    const customers = JSON.parse(localStorage.getItem('customers'));

    if (customers) {
      const matchingCustomer = customers.find(existingCustomer => {
        return existingCustomer.firstName === customer.firstName
          && existingCustomer.lastName === customer.lastName
          && existingCustomer.street === customer.street
          && existingCustomer.NPA === customer.NPA
          && existingCustomer.city === customer.city
          && existingCustomer.birthdate === customer.birthdate;
      });

      if (matchingCustomer)
        matchingCustomer.frequency++;
      else
        customers.push(customer);

      localStorage.setItem('customers', JSON.stringify(customers));
    } else
      localStorage.setItem('customers', JSON.stringify([customer]));
  }

  function dateObjectToDateInput(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');

    return `${date.getFullYear()}-${month}-${day}`;
  }
</script>