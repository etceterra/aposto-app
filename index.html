<!DOCTYPE html>

<head>
  <title>Facturapeute - La tarification 590 facile</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
</head>

<body>
  <div class="container">
    <h1>Facture</h1>
    <form class="form-horizontal" onsubmit=generateReceipt(event)>
      <h2>Informations de l'auteur de la facture</h2>
      <div class="card hide-card" id="author-card">
        <div class="card-header">
          <div class="card-title h5"></div>
        </div>
        <div class="card-body"></div>
        <div class="card-footer"><span class="label label-rounded label-success">Sélectionné</span></div>
      </div>
      <details id="author-details" open>
        <summary>Informations de l'auteur de la facture</summary>
        <div class="form-group">
          <label class="form-label" for="author-name">Nom ou entreprise</label>
          <input class="form-input" type="text" id="author-name" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="author-rcc-number">N° RCC</label>
          <input class="form-input" type="text" id="author-rcc-number" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="author-street">Rue et n°</label>
          <input class="form-input" type="text" id="author-street" required>
        </div>
        <div class="form-group">
          <div class="col-6">
            <label class="form-label" for="author-npa">NPA</label>
            <input class="form-input" type="text" id="author-npa" required>
          </div>
          <div class="col-6">
            <label class="form-label" for="author-city">Localité</label>
            <input class="form-input" type="text" id="author-city" required>
          </div>
        </div>
      </details>
      <h2>Informations du thérapeute</h2>
      <div class="card hide-card" id="therapist-card">
        <div class="card-header">
          <div class="card-title h5"></div>
        </div>
        <div class="card-body"></div>
        <div class="card-footer"><span class="label label-rounded label-success">Sélectionné</span></div>
      </div>
      <details id="therapist-details" open>
        <summary>Informations du thérapeute</summary>
        <div class="form-group">
          <div class="col-6">
            <label class="form-label" for="therapist-first-name">Prénom</label>
            <input class="form-input" type="text" id="therapist-first-name" required>
          </div>
          <div class="col-6">
            <label class="form-label" for="therapist-last-name">Nom</label>
            <input class="form-input" type="text" id="therapist-last-name" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="therapist-rcc-number">N° RCC</label>
          <input class="form-input" type="text" id="therapist-rcc-number" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="therapist-street">Rue et n°</label>
          <input class="form-input" type="text" id="therapist-street" required>
        </div>
        <div class="form-group">
          <div class="col-6">
            <label class="form-label" for="therapist-npa">NPA</label>
            <input class="form-input" type="text" id="therapist-npa" required>
          </div>
          <div class="col-6">
            <label class="form-label" for="therapist-city">Localité</label>
            <input class="form-input" type="text" id="therapist-city" required>
          </div>
        </div>
      </details>
      <h2>Informations du patient</h2>
      <div class="form-group">
        <div class="col-6">
          <label class="form-label" for="customer-first-name">Prénom</label>
          <input class="form-input" type="text" id="customer-first-name" required>
        </div>
        <div class="col-6">
          <label class="form-label" for="customer-last-name">Nom</label>
          <input class="form-input" type="text" id="customer-last-name" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="customer-street">Rue et n°</label>
        <input class="form-input" type="text" id="customer-street" required>
      </div>
      <div class="form-group">
        <div class="col-6">
          <label class="form-label" for="customer-npa">NPA</label>
          <input class="form-input" type="text" id="customer-npa" required>
        </div>
        <div class="col-6">
          <label class="form-label" for="customer-city">Localité</label>
          <input class="form-input" type="text" id="customer-city" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="customer-birthdate">Date de naissance</label>
        <input class="form-input" type="date" id="customer-birthdate" required>
      </div>
      <h2>Description de la séance</h2>
      <div class="form-group">
        <div class="col-2">
          <label class="form-label" for="service-price">Tarif horaire</label>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-price" min="0" max="200" data-amount required>
        </div>
        <div class="col-1">
          <label class="form-label">CHF</label>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-1" required>
            <option value="1003" selected>1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-1" placeholder="Durée (minutes)" step="5" min="0" data-amount required>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-2">
            <option value="" selected></option>
            <option value="1003">1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-2" placeholder="Durée (minutes)" step="5" min="0" data-amount>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-3">
            <option value="" selected></option>
            <option value="1003">1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-3" placeholder="Durée (minutes)" step="5" min="0" data-amount>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-4">
            <option value="" selected></option>
            <option value="1003">1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-4" placeholder="Durée (minutes)" step="5" min="0" data-amount>
        </div>
      </div>
      <div class="form-group">
        <div class="col-9">
          <select class="form-select" id="service-code-5">
            <option value="" selected></option>
            <option value="1003">1003 Acupressure, par période de 5 minutes</option>
            <option value="1004">1004 Acuponcture, par période de 5 minutes</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-input" type="number" id="service-duration-5" placeholder="Durée (minutes)" step="5" min="0" data-amount>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">
          Total : <span id="total-amount">0.0</span> CHF
        </label>
      </div>
      <input class="form-input btn btn-lg btn-primary" type="submit" value="Générer la facture">
    </form>
  </div>
</body>

<style>
  .container {
    width: 750px;
    margin-top: 2rem;
    margin-bottom: 3rem;
  }

  h1 {
    text-align: center;
  }

  h2 {
    margin: 1.5rem 0 0.5rem 0;
  }

  .show-card {
    display: block;
  }

  .hide-card {
    display: none;
  }

  .form-group .col-6:not(:last-child),
  .form-group .col-9 {
    padding-right: 0.75rem;
  }

  .form-group .col-6:last-child,
  .form-group .col-3,
  .form-group .col-1 {
    padding-left: 0.75rem;
  }

  input[type=submit] {
    margin-top: 2rem
  }
</style>

<script src="utils.js"></script>

<script>
  Array.from(document.querySelectorAll('[data-amount]')).forEach(dataAmountElement => {
    dataAmountElement.addEventListener('change', updateTotalAmount);
    dataAmountElement.addEventListener('keyup', updateTotalAmount);
  });

  const author = JSON.parse(localStorage.getItem('author'));
  const therapist = JSON.parse(localStorage.getItem('therapist'));
  const customers = JSON.parse(localStorage.getItem('customers'));
  const servicePrice = JSON.parse(localStorage.getItem('servicePrice'));

  if (author) {
    $('#author-details').open = false;
    $('#author-card').className = 'card show-card';
    $('#author-card .card-header .card-title').innerHTML = author.name;
    $('#author-card .card-body').innerHTML = `${author.RCCNumber}<br>${author.street}, ${author.NPA}, ${author.city}`
    $('#author-name').value = author.name;
    $('#author-rcc-number').value = author.RCCNumber;
    $('#author-street').value = author.street;
    $('#author-npa').value = author.NPA;
    $('#author-city').value = author.city;
  }

  if (therapist) {
    $('#therapist-details').open = false;
    $('#therapist-card').className = 'card show-card';
    $('#therapist-card .card-header .card-title').innerHTML = `${therapist.firstName} ${therapist.lastName}`;
    $('#therapist-card .card-body').innerHTML = `${therapist.RCCNumber}<br>${therapist.street}, ${therapist.NPA}, ${therapist.city}`
    $('#therapist-first-name').value = therapist.firstName;
    $('#therapist-last-name').value = therapist.lastName;
    $('#therapist-rcc-number').value = therapist.RCCNumber;
    $('#therapist-street').value = therapist.street;
    $('#therapist-npa').value = therapist.NPA;
    $('#therapist-city').value = therapist.city;
  }

  if (servicePrice) $('#service-price').value = servicePrice;

  updateTotalAmount();

  function updateTotalAmount() {
    let totalAmount = 0;
    const price = Number($('#service-price').value) / 12;

    for (let i = 1; i <= 5; i++)
      totalAmount += (Number($(`#service-duration-${i}`).value) / 5) * price;

    $('#total-amount').innerHTML = totalAmount.toFixed(2);
  }

  function generateReceipt(e) {
    e.preventDefault();

    const author = {
      name: $('#author-name').value,
      RCCNumber: $('#author-rcc-number').value,
      street: $('#author-street').value,
      NPA: $('#author-npa').value,
      city: $('#author-city').value
    };

    const therapist = {
      firstName: $('#therapist-first-name').value,
      lastName: $('#therapist-last-name').value,
      RCCNumber: $('#therapist-rcc-number').value,
      street: $('#therapist-street').value,
      NPA: $('#therapist-npa').value,
      city: $('#therapist-city').value
    };

    const customer = {
      firstName: $('#customer-first-name').value,
      lastName: $('#customer-last-name').value,
      street: $('#customer-street').value,
      NPA: $('#customer-npa').value,
      city: $('#customer-city').value,
      birthdate: getDateString(new Date($('#customer-birthdate').value)),
    };

    const servicePrice = $('#service-price').value;

    const receiptContent = {
      customer: customer,
      services: []
    };

    for (let i = 1; i <= 5; i++) {
      const serviceCode = $(`#service-code-${i}`).value;

      if (serviceCode) {
        const service = {
          code: serviceCode,
          duration: $(`#service-duration-${i}`).value
        };

        receiptContent.services.push(service);
      }
    }

    if (!localStorage.getItem('author'))
      localStorage.setItem('author', JSON.stringify(author));
    
    if (!localStorage.getItem('therapist'))
      localStorage.setItem('therapist', JSON.stringify(therapist));

    if (!localStorage.getItem('customers'))
      localStorage.setItem('customers', JSON.stringify([ customer ]));
    else if (!customers.includes(customer)) {
      customers.push(customer);
      localStorage.setItem('customers', JSON.stringify(customers));
    }

    if (!localStorage.getItem('servicePrice'))
      localStorage.setItem('servicePrice', JSON.stringify(servicePrice));

    localStorage.setItem('receiptContent', JSON.stringify(receiptContent));

    window.location.href = '/receipt.html';
  };
</script>